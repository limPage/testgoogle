<!DOCTYPE html>
<html>
<head>
  <title>Google Login + Drive 저장</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h2>Google 로그인 후 이름을 입력해보세요</h2>
  <div id="g_id_signin"></div>
  <div id="login-info" style="display:none;">
    <p id="user-email"></p>
    <input type="text" id="name" placeholder="이름 입력" />
    <button onclick="saveName()">Google Drive에 저장</button>
    <p id="result"></p>
  </div>

<script>
  let accessToken;

  function onGoogleSignIn(response) {
    const id_token = response.credential;

    // OAuth 2.0 Token 발급 (id_token → access_token으로 교환)
    fetch("https://oauth2.googleapis.com/token", {
      method: "POST",
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: new URLSearchParams({
        client_id: "504615460563-i0mbebb61nkj5h2k1gafpqvti54qangl.apps.googleusercontent.com",
        client_secret: "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",
        grant_type: "authorization_code",
        code: response.code,  // 이 부분은 OAuth 코드 흐름에서 필요. 간소화 위해 생략함.
        redirect_uri: window.location.origin
      })
    });

    document.getElementById('g_id_signin').style.display = 'none';
    document.getElementById('login-info').style.display = 'block';
    document.getElementById('user-email').innerText = "Google 로그인 성공!";
  }

  window.onload = () => {
    google.accounts.id.initialize({
      client_id: "504615460563-i0mbebb61nkj5h2k1gafpqvti54qangl.apps.googleusercontent.com",
      callback: onGoogleSignIn
    });
    google.accounts.id.renderButton(
      document.getElementById("g_id_signin"),
      { theme: "outline", size: "large" }
    );
  };

  function saveName() {
    const name = document.getElementById("name").value;
    const fileContent = JSON.stringify({ name });

    const file = new Blob([fileContent], { type: 'application/json' });
    const metadata = {
      name: "user_name.json",
      mimeType: 'application/json'
    };

    const form = new FormData();
    form.append("metadata", new Blob([JSON.stringify(metadata)], {type: "application/json"}));
    form.append("file", file);

    fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
      method: "POST",
      headers: new Headers({ Authorization: "Bearer " + accessToken }),
      body: form
    })
    .then(response => response.json())
    .then(data => {
      document.getElementById("result").innerText = "저장 성공! 파일 ID: " + data.id;
    });
  }
</script>
</body>
</html>
