<!DOCTYPE html>
<html>
<head>
  <title>Google ë¡œê·¸ì¸ + ì´ë¦„ ì €ì¥ (GIS ê¸°ë°˜)</title>
  <meta name="google-signin-client_id" content="504615460563-i0mbebb61nkj5h2k1gafpqvti54qangl.apps.googleusercontent.com">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h2>Google ë¡œê·¸ì¸ í›„ ì´ë¦„ì„ ì…ë ¥í•´ë³´ì„¸ìš”</h2>
  <div id="g_id_onload"
       data-client_id="504615460563-i0mbebb61nkj5h2k1gafpqvti54qangl.apps.googleusercontent.com"
       data-login_uri=""
       data-callback="onLogin"
       data-scope="https://www.googleapis.com/auth/drive.file">
  </div>
  <div id="g_id_signin"></div>

  <div id="login-info" style="display:none; margin-top:20px;">
    <p id="user-email"></p>
    <input type="text" id="name" placeholder="ì´ë¦„ ì…ë ¥" />
    <button onclick="saveName()">Google Driveì— ì €ì¥</button>
    <p id="result"></p>
  </div>
  <button onclick="loadName()">Google Driveì—ì„œ ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸°</button>
<ul id="name-list"></ul>

  <script>
    let accessToken = null;

    function onLogin(response) {
      const credential = response.credential;

      // ID Tokenì„ Access Tokenìœ¼ë¡œ ë°”ê¿€ ìˆ˜ ì—†ìŒ (GISëŠ” accessToken ì§ì ‘ ì•ˆ ì¤Œ)
      // ëŒ€ì‹  popup ë°©ì‹ OAuth Flow ì‚¬ìš© í•„ìš”

      google.accounts.oauth2.initTokenClient({
        client_id: "504615460563-i0mbebb61nkj5h2k1gafpqvti54qangl.apps.googleusercontent.com",
        scope: "https://www.googleapis.com/auth/drive.file",
        callback: (tokenResponse) => {
          accessToken = tokenResponse.access_token;
          document.getElementById("login-info").style.display = "block";
          document.getElementById("user-email").innerText = "ë¡œê·¸ì¸ ì„±ê³µ!";
        }
      }).requestAccessToken();
    }

    function saveName() {
      const name = document.getElementById("name").value;
      const fileContent = JSON.stringify({ name });

      const metadata = {
        name: "user_name.json",
        mimeType: "application/json"
      };

      const form = new FormData();
      form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
      form.append("file", new Blob([fileContent], { type: "application/json" }));

      fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
        method: "POST",
        headers: new Headers({
          Authorization: "Bearer " + accessToken
        }),
        body: form
      })
      .then(res => res.json())
      .then(data => {
        if (data.id) {
          document.getElementById("result").innerText = "âœ… ì €ì¥ ì„±ê³µ! íŒŒì¼ ID: " + data.id;
        } else {
          document.getElementById("result").innerText = "âš ï¸ ì €ì¥ ì‹¤íŒ¨: " + JSON.stringify(data);
        }
      })
      .catch(err => {
        console.error(err);
        document.getElementById("result").innerText = "âŒ ì—ëŸ¬ ë°œìƒ: " + err.message;
      });
    }

    function loadName() {
  // 1. Driveì—ì„œ "user_name.json" íŒŒì¼ ê²€ìƒ‰
  fetch("https://www.googleapis.com/drive/v3/files?q=name='user_name.json' and trashed=false", {
    headers: {
      Authorization: "Bearer " + accessToken
    }
  })
  .then(res => res.json())
  .then(fileList => {
    if (!fileList.files || fileList.files.length === 0) {
      document.getElementById("result").innerText = "âŒ ì €ì¥ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.";
      return;
    }

    const fileId = fileList.files[0].id;

    // 2. íŒŒì¼ ë‚´ìš©ì„ ì½ê¸°
    return fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
      headers: {
        Authorization: "Bearer " + accessToken
      }
    });
  })
  .then(res => res.json())
  .then(data => {
    if (data && data.name) {
      const ul = document.getElementById("name-list");
      ul.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
      const li = document.createElement("li");
      li.innerText = `ğŸ‘¤ ì´ë¦„: ${data.name}`;
      ul.appendChild(li);
    }
  })
  .catch(err => {
    console.error("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
    document.getElementById("result").innerText = "âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err.message;
  });
}
  </script>
  
</body>
</html>
